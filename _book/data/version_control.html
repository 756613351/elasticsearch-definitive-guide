<!DOCTYPE HTML>
<html lang="en-US" manifest="../manifest.appcache">
    
    <head prefix="og: http://ogp.me/ns# book: http://ogp.me/ns/book#">
        
        
        <meta charset="UTF-8">
        <title>版本控制 | Elasticsearch 权威指南</title>

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="robots" content="index, follow">
        <meta name="author" content="">
        <meta name="description" content="译者现在的工作项目中需要用到elasticsearch，但是在网络中找了很多的相关的内容都很不完善，中文的文档更是寥寥无几，所以我决定边研究边翻译一下官方推出的权威手册。在这里要先感谢原作者们！如果各位在这里发现了错误之处，请大家在Issue中提出或者pr这个项目。">
        <meta name="keywords" content="gitbook,github" >
        <meta name="generator" content="www.gitbook.io">

        
        <link rel="next" href="../data/partial_update.html" />
        
        
        <link rel="prev" href="../data/delete.html" />
        

        <meta property="og:title" content="版本控制 | Elasticsearch 权威指南">
        <meta property="og:site_name" content="Elasticsearch 权威指南">
        <meta property="og:type" content="book">
        <meta property="og:locale" content="en_US">

        <meta property="book:author" content="https://github.com/">
        <meta property="book:tag" content="GitBook">

        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">

        <link rel="shortcut icon" href="..\gitbook/images/favicon.ico" type="image/x-icon">
        
        
    </head>
    <body>
        
        

        <link rel="stylesheet" href="..\gitbook/style.css">
        


        
    <div class="book"  data-level="3.8" data-basepath=".." data-revision="1402135601274">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="https://github.com/null" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../" >Elasticsearch 权威指南</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        

        

        

        

        <li data-level="0" data-path="index.html">
            <a href="../"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
    
        <li class="chapter " data-level="1" data-path="getting_started/README.html">
            
            <a href="../getting_started/README.html">
                <i class="fa fa-check"></i> <b>1.</b> 入门
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="getting_started/what_is_it.html">
            
            <a href="../getting_started/what_is_it.html">
                <i class="fa fa-check"></i> <b>1.1.</b> 初识
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="getting_started/installing_es.html">
            
            <a href="../getting_started/installing_es.html">
                <i class="fa fa-check"></i> <b>1.2.</b> 安装
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="getting_started/api.html">
            
            <a href="../getting_started/api.html">
                <i class="fa fa-check"></i> <b>1.3.</b> API
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="getting_started/document.html">
            
            <a href="../getting_started/document.html">
                <i class="fa fa-check"></i> <b>1.4.</b> 文档
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="getting_started/tutorial_indexing.html">
            
            <a href="../getting_started/tutorial_indexing.html">
                <i class="fa fa-check"></i> <b>1.5.</b> 索引
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="getting_started/tutorial_search.html">
            
            <a href="../getting_started/tutorial_search.html">
                <i class="fa fa-check"></i> <b>1.6.</b> 搜索
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="getting_started/tutorial_aggregations.html">
            
            <a href="../getting_started/tutorial_aggregations.html">
                <i class="fa fa-check"></i> <b>1.7.</b> 汇总
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="getting_started/tutorial_conclusion.html">
            
            <a href="../getting_started/tutorial_conclusion.html">
                <i class="fa fa-check"></i> <b>1.8.</b> 小结
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="getting_started/distributed.html">
            
            <a href="../getting_started/distributed.html">
                <i class="fa fa-check"></i> <b>1.9.</b> 分布式
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="getting_started/conclusion.html">
            
            <a href="../getting_started/conclusion.html">
                <i class="fa fa-check"></i> <b>1.10.</b> 本章总结
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="distributed_cluster/README.html">
            
            <a href="../distributed_cluster/README.html">
                <i class="fa fa-check"></i> <b>2.</b> 分布式集群
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="distributed_cluster/empty_cluster.html">
            
            <a href="../distributed_cluster/empty_cluster.html">
                <i class="fa fa-check"></i> <b>2.1.</b> 空集群
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="distributed_cluster/cluster_health.html">
            
            <a href="../distributed_cluster/cluster_health.html">
                <i class="fa fa-check"></i> <b>2.2.</b> 集群健康
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="distributed_cluster/add_an_index.html">
            
            <a href="../distributed_cluster/add_an_index.html">
                <i class="fa fa-check"></i> <b>2.3.</b> 添加索引
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="distributed_cluster/add_failover.html">
            
            <a href="../distributed_cluster/add_failover.html">
                <i class="fa fa-check"></i> <b>2.4.</b> 容错移转
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="distributed_cluster/scale_horizontally.html">
            
            <a href="../distributed_cluster/scale_horizontally.html">
                <i class="fa fa-check"></i> <b>2.5.</b> 横向扩展
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="distributed_cluster/scale_more.html">
            
            <a href="../distributed_cluster/scale_more.html">
                <i class="fa fa-check"></i> <b>2.6.</b> 扩展
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="distributed_cluster/coping_with_failure.html">
            
            <a href="../distributed_cluster/coping_with_failure.html">
                <i class="fa fa-check"></i> <b>2.7.</b> 错误恢复
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="data/README.html">
            
            <a href="../data/README.html">
                <i class="fa fa-check"></i> <b>3.</b> 数据
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="data/document.html">
            
            <a href="../data/document.html">
                <i class="fa fa-check"></i> <b>3.1.</b> 文档
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="data/index.html">
            
            <a href="../data/index.html">
                <i class="fa fa-check"></i> <b>3.2.</b> 索引
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="data/get.html">
            
            <a href="../data/get.html">
                <i class="fa fa-check"></i> <b>3.3.</b> Get
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="data/exists.html">
            
            <a href="../data/exists.html">
                <i class="fa fa-check"></i> <b>3.4.</b> 存在
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="data/update.html">
            
            <a href="../data/update.html">
                <i class="fa fa-check"></i> <b>3.5.</b> 更新
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="data/create.html">
            
            <a href="../data/create.html">
                <i class="fa fa-check"></i> <b>3.6.</b> 创建
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="data/delete.html">
            
            <a href="../data/delete.html">
                <i class="fa fa-check"></i> <b>3.7.</b> 删除
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="data/version_control.html">
            
            <a href="../data/version_control.html">
                <i class="fa fa-check"></i> <b>3.8.</b> 版本控制
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="data/partial_update.html">
            
            <a href="../data/partial_update.html">
                <i class="fa fa-check"></i> <b>3.9.</b> 局部更新
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.10" data-path="data/mget.html">
            
            <a href="../data/mget.html">
                <i class="fa fa-check"></i> <b>3.10.</b> Mget
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.11" data-path="data/bulk.html">
            
            <a href="../data/bulk.html">
                <i class="fa fa-check"></i> <b>3.11.</b> Bulk
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.12" data-path="data/conclusion.html">
            
            <a href="../data/conclusion.html">
                <i class="fa fa-check"></i> <b>3.12.</b> 总结
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 96.875%;min-width: 93.75%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../getting_started/README.html" title="入门" class="chapter done new-chapter" data-progress="1" style="left: 3.125%;"></a>
    
        <a href="../getting_started/what_is_it.html" title="初识" class="chapter done " data-progress="1.1" style="left: 6.25%;"></a>
    
        <a href="../getting_started/conclusion.html" title="本章总结" class="chapter done " data-progress="1.10" style="left: 9.375%;"></a>
    
        <a href="../getting_started/installing_es.html" title="安装" class="chapter done " data-progress="1.2" style="left: 12.5%;"></a>
    
        <a href="../getting_started/api.html" title="API" class="chapter done " data-progress="1.3" style="left: 15.625%;"></a>
    
        <a href="../getting_started/document.html" title="文档" class="chapter done " data-progress="1.4" style="left: 18.75%;"></a>
    
        <a href="../getting_started/tutorial_indexing.html" title="索引" class="chapter done " data-progress="1.5" style="left: 21.875%;"></a>
    
        <a href="../getting_started/tutorial_search.html" title="搜索" class="chapter done " data-progress="1.6" style="left: 25%;"></a>
    
        <a href="../getting_started/tutorial_aggregations.html" title="汇总" class="chapter done " data-progress="1.7" style="left: 28.125%;"></a>
    
        <a href="../getting_started/tutorial_conclusion.html" title="小结" class="chapter done " data-progress="1.8" style="left: 31.25%;"></a>
    
        <a href="../getting_started/distributed.html" title="分布式" class="chapter done " data-progress="1.9" style="left: 34.375%;"></a>
    
        <a href="../distributed_cluster/README.html" title="分布式集群" class="chapter done new-chapter" data-progress="2" style="left: 37.5%;"></a>
    
        <a href="../distributed_cluster/empty_cluster.html" title="空集群" class="chapter done " data-progress="2.1" style="left: 40.625%;"></a>
    
        <a href="../distributed_cluster/cluster_health.html" title="集群健康" class="chapter done " data-progress="2.2" style="left: 43.75%;"></a>
    
        <a href="../distributed_cluster/add_an_index.html" title="添加索引" class="chapter done " data-progress="2.3" style="left: 46.875%;"></a>
    
        <a href="../distributed_cluster/add_failover.html" title="容错移转" class="chapter done " data-progress="2.4" style="left: 50%;"></a>
    
        <a href="../distributed_cluster/scale_horizontally.html" title="横向扩展" class="chapter done " data-progress="2.5" style="left: 53.125%;"></a>
    
        <a href="../distributed_cluster/scale_more.html" title="扩展" class="chapter done " data-progress="2.6" style="left: 56.25%;"></a>
    
        <a href="../distributed_cluster/coping_with_failure.html" title="错误恢复" class="chapter done " data-progress="2.7" style="left: 59.375%;"></a>
    
        <a href="../data/README.html" title="数据" class="chapter done new-chapter" data-progress="3" style="left: 62.5%;"></a>
    
        <a href="../data/document.html" title="文档" class="chapter done " data-progress="3.1" style="left: 65.625%;"></a>
    
        <a href="../data/mget.html" title="Mget" class="chapter done " data-progress="3.10" style="left: 68.75%;"></a>
    
        <a href="../data/bulk.html" title="Bulk" class="chapter done " data-progress="3.11" style="left: 71.875%;"></a>
    
        <a href="../data/conclusion.html" title="总结" class="chapter done " data-progress="3.12" style="left: 75%;"></a>
    
        <a href="../data/index.html" title="索引" class="chapter done " data-progress="3.2" style="left: 78.125%;"></a>
    
        <a href="../data/get.html" title="Get" class="chapter done " data-progress="3.3" style="left: 81.25%;"></a>
    
        <a href="../data/exists.html" title="存在" class="chapter done " data-progress="3.4" style="left: 84.375%;"></a>
    
        <a href="../data/update.html" title="更新" class="chapter done " data-progress="3.5" style="left: 87.5%;"></a>
    
        <a href="../data/create.html" title="创建" class="chapter done " data-progress="3.6" style="left: 90.625%;"></a>
    
        <a href="../data/delete.html" title="删除" class="chapter done " data-progress="3.7" style="left: 93.75%;"></a>
    
        <a href="../data/version_control.html" title="版本控制" class="chapter done " data-progress="3.8" style="left: 96.875%;"></a>
    
        <a href="../data/partial_update.html" title="局部更新" class="chapter  " data-progress="3.9" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_8198">
                    
                        <h1 id="-">处理冲突</h1>
<p>When updating a document using the <code>index</code> API, we read the original document,
make our changes, then reindex the <em>whole document</em> in one go. The most recent
indexing request wins -- whichever document was indexed last is the one stored
in Elasticsearch. If somebody else had changed the document in the meantime,
their changes would be lost.</p>
<p>Many times, this is not a problem.  Perhaps our main data store is a
relational database, and we just copy the data into Elasticsearch to make it
searchable. Perhaps there is little chance of two people changing the same
document at the same time. Or perhaps it doesn&#39;t really matter to our business
if we lose changes occasionally.</p>
<p>But sometimes losing a change is <em>very important</em>.  Imagine that we&#39;re using
Elasticsearch to store the number of widgets that we have in stock in our
online store. Every time that we sell a widget, we decrement the stock count
in Elasticsearch.</p>
<p>One day, management decides to have a sale. Suddenly, we are selling several
widgets every second. Imagine two web processes, running in parallel, both
processing the sale of one widget each:</p>
<p>[[img-data-lww]]
.Consequence of no concurrency control
image::images/03-01_concurrency.png[&quot;Consequence of no concurrency control&quot;,width=&quot;50%&quot;,align=&quot;center&quot;]</p>
<p>The change that <code>web_1</code> made to the <code>stock_count</code> has been lost because
<code>web_2</code> is unaware that its copy of the <code>stock_count</code> is out of date. The
result is that we think we have more widgets than we actually do, and we&#39;re
going to disappoint customers by selling them stock that doesn&#39;t exist.</p>
<p>The more frequently that changes are made, or the longer the gap between
reading data and updating it, the more likely it is that we will lose changes.</p>
<p>There are two approaches to ensuring that changes are not lost when
making concurrent updates:</p>
<p><em>Pessimistic concurrency control</em>::</p>
<p>widely used by relational databases, assumes that conflicting changes are
likely to happen and so blocks access to a resource in order to prevent
conflicts. A typical example of this is locking a row before reading its data,
ensuring that only the thread which placed the lock is able to make changes to
the data in that row.</p>
<p><em>Optimistic concurrency control</em>::</p>
<p>used by Elasticsearch, assumes that conflicts are unlikely to happen and
doesn&#39;t block operations from being attempted. However, if the underlying data
has been modified between reading and writing, the update will fail. It is
then up to the application to decide how it should resolve the conflict. For
instance, it could reattempt the update, using the fresh data, or it could
report the situation to the user.</p>
<h2 id="optimistic-concurrency-control">Optimistic concurrency control</h2>
<p>Elasticsearch is distributed.  When documents are created, updated or deleted,
the new version of the document has to be replicated to other nodes in the
cluster.  Elasticsearch is also asynchronous and  concurrent, meaning that
these replication requests are sent in parallel, and may arrive at their
destination <em>out of sequence</em>. It needs a way of ensuring that an older
version of a document never overwrites a newer version.</p>
<p>When we discussed <code>index</code>, <code>get</code> and <code>delete</code> requests above, we pointed out
that every document has a <code>_version</code> number which is incremented whenever a
document is changed. Elasticsearch uses this <code>_version</code> number to ensure that
changes are applied in the correct order. If an older version of a document
arrives after a new version, it can simply be ignored.</p>
<p>We can take advantage of the <code>_version</code> number to ensure that conflicting
changes made by our application do not result in data loss. We do this by
specifying the <code>version</code> number of the document that we wish to change.  If that
version is no longer current, our request fails.</p>
<p>Let&#39;s create a new blog post:</p>
<pre><code class="lang-js">PUT /website/blog/<span class="hljs-number">1</span>/_create
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Just trying this out..."</span>
}
</code></pre>
<p>The response body tells us that this newly created document has <code>_version</code>
number <code>1</code>.  Now imagine that we want to edit the document: we load its data
into a web form, make our changes, then save the new version.</p>
<p>First we retrieve the document:</p>
<pre><code class="lang-js">GET /website/blog/<span class="hljs-number">1</span>
</code></pre>
<p>The response body includes the same <code>_version</code> number of <code>1</code>:</p>
<pre><code class="lang-js">{
  <span class="hljs-string">"_index"</span> :   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span> :    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span> :      <span class="hljs-string">"1"</span>,
  <span class="hljs-string">"_version"</span> : <span class="hljs-number">1</span>,
  <span class="hljs-string">"found"</span> :    <span class="hljs-literal">true</span>,
  <span class="hljs-string">"_source"</span> :  {
      <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first blog entry"</span>,
      <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Just trying this out..."</span>
  }
}
</code></pre>
<p>Now, when we try to save our changes by reindexing the document, we specify
the <code>version</code> to which our changes should be applied:</p>
<pre><code class="lang-js">PUT /website/blog/<span class="hljs-number">1</span>?version=<span class="hljs-number">1</span> &lt;<span class="hljs-number">1</span>&gt;
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Starting to get the hang of this..."</span>
}
</code></pre>
<ol>
<li>We want this update to succeed only if the current <code>_version</code> of this
 document in our index is version <code>1</code>.</li>
</ol>
<p>This request succeeds, and the response body tells us that the <code>_version</code>
has been incremented to <code>2</code>:</p>
<pre><code class="lang-js">{
  <span class="hljs-string">"_index"</span>:   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span>:    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span>:      <span class="hljs-string">"1"</span>,
  <span class="hljs-string">"_version"</span>: <span class="hljs-number">2</span>
  <span class="hljs-string">"created"</span>:  <span class="hljs-literal">false</span>
}
</code></pre>
<p>However, if we were to rerun the same index request, still specifying
<code>version=1</code>, Elasticsearch would respond with a <code>409 Conflict</code> HTTP response
code, and a body like the following:</p>
<pre><code class="lang-js">{
  &quot;error&quot; : &quot;VersionConflictEngineException[[website][2] [blog][1]:
             version conflict, current [2], provided [1]]&quot;,
  &quot;status&quot; : 409
}
</code></pre>
<p>This tells us that the current <code>_version</code> number of the document in
Elasticsearch is <code>2</code>, but that we specified that we were updating version <code>1</code>.</p>
<p>What we do now depends upon our application requirements.  We could tell the
user that somebody else has already made changes to the document, and that
they should review the changes before trying to save them again.
Alternatively, as in the case of the widget <code>stock_count</code> above, we could
retrieve the latest document and try to reapply the change.</p>
<p>All APIs which update or delete a document accept a <code>version</code> parameter, which
allows you to apply optimistic concurrency control to just the parts of your
code where it makes sense.</p>
<h3 id="using-versions-from-an-external-system">Using versions from an external system</h3>
<p>A common setup is to use some other database as the primary datastore and
Elasticsearch to make the data searchable, which means that all changes to the
primary database need to be copied across to Elasticsearch as they happen.  If
multiple processes are responsible for this data synchronization, then you may
run into concurrency problems similar to those described above.</p>
<p>If your main database already has version numbers -- or some value like a
<code>timestamp</code> which can be used as a version number -- then  you can reuse these
same version numbers in Elasticsearch by adding <code>version_type=external</code> to the
query string. Version numbers must be integers greater than zero and less than
about <code>9.2e+18</code> -- a positive <code>long</code> value in Java.</p>
<p>The way external version numbers are handled is a bit different to the
internal version numbers  we discussed above.  Instead of checking that the
current <code>_version</code> is <em>the same</em> as the one specified in the request,
Elasticsearch checks that the current <code>_version</code> is <em>less than</em> the specified
version. If the request succeeds, the external version number is stored as the
document&#39;s new <code>_version</code>.</p>
<p>External version numbers can be specified not only on
index and delete requests, but also when <em>creating</em> new documents.</p>
<p>For instance, to create a new blog post with an external version number
of <code>5</code>, we can do the following:</p>
<pre><code class="lang-js">PUT /website/blog/<span class="hljs-number">2</span>?version=<span class="hljs-number">5</span>&amp;version_type=external
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first external blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Starting to get the hang of this..."</span>
}
</code></pre>
<p>In the response, we can see that the current <code>_version</code> number is <code>5</code>:</p>
<pre><code class="lang-js">{
  <span class="hljs-string">"_index"</span>:   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span>:    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span>:      <span class="hljs-string">"2"</span>,
  <span class="hljs-string">"_version"</span>: <span class="hljs-number">5</span>,
  <span class="hljs-string">"created"</span>:  <span class="hljs-literal">true</span>
}
</code></pre>
<p>Now we update this document, specifying a new <code>version</code> number of <code>10</code>:</p>
<pre><code class="lang-js">PUT /website/blog/<span class="hljs-number">2</span>?version=<span class="hljs-number">10</span>&amp;version_type=external
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first external blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"This is a piece of cake..."</span>
}
</code></pre>
<p>The request succeeds and sets the current <code>_version</code> to <code>10</code>:</p>
<pre><code class="lang-js">{
  <span class="hljs-string">"_index"</span>:   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span>:    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span>:      <span class="hljs-string">"2"</span>,
  <span class="hljs-string">"_version"</span>: <span class="hljs-number">10</span>,
  <span class="hljs-string">"created"</span>:  <span class="hljs-literal">false</span>
}
</code></pre>
<p>If you were to rerun this request, it would fail with the same conflict error
we saw before, because the specified external version number is not higher
than the current version in Elasticsearch.</p>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../data/delete.html" class="navigation navigation-prev " aria-label="Previous page: 删除"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../data/partial_update.html" class="navigation navigation-next " aria-label="Next page: 局部更新"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        

        <script src="http://cdn.bootcss.com/ace/1.1.3/ace.js"></script>
        <script src="http://cdn.bootcss.com/ace/1.1.3/mode-javascript.js"></script>
        <script src="..\gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
        <script src="..\gitbook/app.js"></script>
        

    
    <script src="..\gitbook/plugins/gitbook-plugin-mixpanel/plugin.js"></script>
    

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="..\gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
