<!DOCTYPE HTML>
<html lang="en-US" manifest="../manifest.appcache">
    
    <head>
        
        <meta charset="UTF-8">
        <title>局部更新 | Elasticsearch 权威指南</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 0.5.2">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../data/mget.html" />
    
    
    <link rel="prev" href="../data/version_control.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="3.9" data-basepath=".." data-revision="1402252541430">
    <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    
    <a href="https://github.com/null" target="_blank" class="btn pull-left home-bookmark" aria-label="GitHub home"><i class="fa fa-bookmark-o"></i></a>
    
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    <span id="font-settings-wrapper">
        <a href="#" class="btn pull-left toggle-font-settings" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="btn-group btn-block">
        <button id="reduce-font-size" class="btn btn-default">A</button>
        <button id="enlarge-font-size" class="btn btn-default">A</button>
    </div>

    <ul class="list-group font-family-list">
        <li class="list-group-item" data-font="0">Serif</li>
        <li class="list-group-item" data-font="1">Sans</li>
    </ul>

    <div class="btn-group btn-group-xs btn-block color-theme-list">
        <button type="button" class="btn btn-default" id="color-theme-preview-0" data-theme="0">White</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-1" data-theme="1">Sepia</button>
        <button type="button" class="btn btn-default" id="color-theme-preview-2" data-theme="2">Night</button>
    </div>
</div>

    </span>

    <!-- Actions Right -->
    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    

    

    <!-- Title -->
    <h1>
        <i class="fa fa-spinner fa-spin"></i>
        <a href="../" >Elasticsearch 权威指南</a>
    </h1>
</div>

    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Search" class="form-control" />
    </div>
    <ul class="summary">
        
        

        

        

        

        <li data-level="0" data-path="index.html">
            <a href="../"><i class="fa fa-check"></i> Introduction</a>
        </li>
        
    
        <li class="chapter " data-level="1" data-path="getting_started/README.html">
            
            <a href="../getting_started/README.html">
                <i class="fa fa-check"></i> <b>1.</b> 入门
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="getting_started/what_is_it.html">
            
            <a href="../getting_started/what_is_it.html">
                <i class="fa fa-check"></i> <b>1.1.</b> 初识
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="getting_started/installing_es.html">
            
            <a href="../getting_started/installing_es.html">
                <i class="fa fa-check"></i> <b>1.2.</b> 安装
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="getting_started/api.html">
            
            <a href="../getting_started/api.html">
                <i class="fa fa-check"></i> <b>1.3.</b> API
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="getting_started/document.html">
            
            <a href="../getting_started/document.html">
                <i class="fa fa-check"></i> <b>1.4.</b> 文档
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="getting_started/tutorial_indexing.html">
            
            <a href="../getting_started/tutorial_indexing.html">
                <i class="fa fa-check"></i> <b>1.5.</b> 索引
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="getting_started/tutorial_search.html">
            
            <a href="../getting_started/tutorial_search.html">
                <i class="fa fa-check"></i> <b>1.6.</b> 搜索
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="getting_started/tutorial_aggregations.html">
            
            <a href="../getting_started/tutorial_aggregations.html">
                <i class="fa fa-check"></i> <b>1.7.</b> 汇总
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="getting_started/tutorial_conclusion.html">
            
            <a href="../getting_started/tutorial_conclusion.html">
                <i class="fa fa-check"></i> <b>1.8.</b> 小结
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="getting_started/distributed.html">
            
            <a href="../getting_started/distributed.html">
                <i class="fa fa-check"></i> <b>1.9.</b> 分布式
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="getting_started/conclusion.html">
            
            <a href="../getting_started/conclusion.html">
                <i class="fa fa-check"></i> <b>1.10.</b> 本章总结
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="distributed_cluster/README.html">
            
            <a href="../distributed_cluster/README.html">
                <i class="fa fa-check"></i> <b>2.</b> 分布式集群
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="distributed_cluster/empty_cluster.html">
            
            <a href="../distributed_cluster/empty_cluster.html">
                <i class="fa fa-check"></i> <b>2.1.</b> 空集群
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="distributed_cluster/cluster_health.html">
            
            <a href="../distributed_cluster/cluster_health.html">
                <i class="fa fa-check"></i> <b>2.2.</b> 集群健康
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="distributed_cluster/add_an_index.html">
            
            <a href="../distributed_cluster/add_an_index.html">
                <i class="fa fa-check"></i> <b>2.3.</b> 添加索引
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="distributed_cluster/add_failover.html">
            
            <a href="../distributed_cluster/add_failover.html">
                <i class="fa fa-check"></i> <b>2.4.</b> 容错移转
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="distributed_cluster/scale_horizontally.html">
            
            <a href="../distributed_cluster/scale_horizontally.html">
                <i class="fa fa-check"></i> <b>2.5.</b> 横向扩展
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="distributed_cluster/scale_more.html">
            
            <a href="../distributed_cluster/scale_more.html">
                <i class="fa fa-check"></i> <b>2.6.</b> 扩展
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="distributed_cluster/coping_with_failure.html">
            
            <a href="../distributed_cluster/coping_with_failure.html">
                <i class="fa fa-check"></i> <b>2.7.</b> 错误恢复
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="data/README.html">
            
            <a href="../data/README.html">
                <i class="fa fa-check"></i> <b>3.</b> 数据
            </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="data/document.html">
            
            <a href="../data/document.html">
                <i class="fa fa-check"></i> <b>3.1.</b> 文档
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="data/index.html">
            
            <a href="../data/index.html">
                <i class="fa fa-check"></i> <b>3.2.</b> 索引
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="data/get.html">
            
            <a href="../data/get.html">
                <i class="fa fa-check"></i> <b>3.3.</b> Get
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="data/exists.html">
            
            <a href="../data/exists.html">
                <i class="fa fa-check"></i> <b>3.4.</b> 存在
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="data/update.html">
            
            <a href="../data/update.html">
                <i class="fa fa-check"></i> <b>3.5.</b> 更新
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="data/create.html">
            
            <a href="../data/create.html">
                <i class="fa fa-check"></i> <b>3.6.</b> 创建
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="data/delete.html">
            
            <a href="../data/delete.html">
                <i class="fa fa-check"></i> <b>3.7.</b> 删除
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.8" data-path="data/version_control.html">
            
            <a href="../data/version_control.html">
                <i class="fa fa-check"></i> <b>3.8.</b> 版本控制
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.9" data-path="data/partial_update.html">
            
            <a href="../data/partial_update.html">
                <i class="fa fa-check"></i> <b>3.9.</b> 局部更新
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.10" data-path="data/mget.html">
            
            <a href="../data/mget.html">
                <i class="fa fa-check"></i> <b>3.10.</b> Mget
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.11" data-path="data/bulk.html">
            
            <a href="../data/bulk.html">
                <i class="fa fa-check"></i> <b>3.11.</b> Bulk
            </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.12" data-path="data/conclusion.html">
            
            <a href="../data/conclusion.html">
                <i class="fa fa-check"></i> <b>3.12.</b> 总结
            </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Generated using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="page-wrapper" tabindex="-1">
                <div class="book-progress">
    <div class="bar">
        <div class="inner" style="width: 100%;min-width: 96.875%;"></div>
    </div>
    <div class="chapters">
    
        <a href="../index.html" title="Introduction" class="chapter done new-chapter" data-progress="0" style="left: 0%;"></a>
    
        <a href="../getting_started/README.html" title="入门" class="chapter done new-chapter" data-progress="1" style="left: 3.125%;"></a>
    
        <a href="../getting_started/what_is_it.html" title="初识" class="chapter done " data-progress="1.1" style="left: 6.25%;"></a>
    
        <a href="../getting_started/conclusion.html" title="本章总结" class="chapter done " data-progress="1.10" style="left: 9.375%;"></a>
    
        <a href="../getting_started/installing_es.html" title="安装" class="chapter done " data-progress="1.2" style="left: 12.5%;"></a>
    
        <a href="../getting_started/api.html" title="API" class="chapter done " data-progress="1.3" style="left: 15.625%;"></a>
    
        <a href="../getting_started/document.html" title="文档" class="chapter done " data-progress="1.4" style="left: 18.75%;"></a>
    
        <a href="../getting_started/tutorial_indexing.html" title="索引" class="chapter done " data-progress="1.5" style="left: 21.875%;"></a>
    
        <a href="../getting_started/tutorial_search.html" title="搜索" class="chapter done " data-progress="1.6" style="left: 25%;"></a>
    
        <a href="../getting_started/tutorial_aggregations.html" title="汇总" class="chapter done " data-progress="1.7" style="left: 28.125%;"></a>
    
        <a href="../getting_started/tutorial_conclusion.html" title="小结" class="chapter done " data-progress="1.8" style="left: 31.25%;"></a>
    
        <a href="../getting_started/distributed.html" title="分布式" class="chapter done " data-progress="1.9" style="left: 34.375%;"></a>
    
        <a href="../distributed_cluster/README.html" title="分布式集群" class="chapter done new-chapter" data-progress="2" style="left: 37.5%;"></a>
    
        <a href="../distributed_cluster/empty_cluster.html" title="空集群" class="chapter done " data-progress="2.1" style="left: 40.625%;"></a>
    
        <a href="../distributed_cluster/cluster_health.html" title="集群健康" class="chapter done " data-progress="2.2" style="left: 43.75%;"></a>
    
        <a href="../distributed_cluster/add_an_index.html" title="添加索引" class="chapter done " data-progress="2.3" style="left: 46.875%;"></a>
    
        <a href="../distributed_cluster/add_failover.html" title="容错移转" class="chapter done " data-progress="2.4" style="left: 50%;"></a>
    
        <a href="../distributed_cluster/scale_horizontally.html" title="横向扩展" class="chapter done " data-progress="2.5" style="left: 53.125%;"></a>
    
        <a href="../distributed_cluster/scale_more.html" title="扩展" class="chapter done " data-progress="2.6" style="left: 56.25%;"></a>
    
        <a href="../distributed_cluster/coping_with_failure.html" title="错误恢复" class="chapter done " data-progress="2.7" style="left: 59.375%;"></a>
    
        <a href="../data/README.html" title="数据" class="chapter done new-chapter" data-progress="3" style="left: 62.5%;"></a>
    
        <a href="../data/document.html" title="文档" class="chapter done " data-progress="3.1" style="left: 65.625%;"></a>
    
        <a href="../data/mget.html" title="Mget" class="chapter done " data-progress="3.10" style="left: 68.75%;"></a>
    
        <a href="../data/bulk.html" title="Bulk" class="chapter done " data-progress="3.11" style="left: 71.875%;"></a>
    
        <a href="../data/conclusion.html" title="总结" class="chapter done " data-progress="3.12" style="left: 75%;"></a>
    
        <a href="../data/index.html" title="索引" class="chapter done " data-progress="3.2" style="left: 78.125%;"></a>
    
        <a href="../data/get.html" title="Get" class="chapter done " data-progress="3.3" style="left: 81.25%;"></a>
    
        <a href="../data/exists.html" title="存在" class="chapter done " data-progress="3.4" style="left: 84.375%;"></a>
    
        <a href="../data/update.html" title="更新" class="chapter done " data-progress="3.5" style="left: 87.5%;"></a>
    
        <a href="../data/create.html" title="创建" class="chapter done " data-progress="3.6" style="left: 90.625%;"></a>
    
        <a href="../data/delete.html" title="删除" class="chapter done " data-progress="3.7" style="left: 93.75%;"></a>
    
        <a href="../data/version_control.html" title="版本控制" class="chapter done " data-progress="3.8" style="left: 96.875%;"></a>
    
        <a href="../data/partial_update.html" title="局部更新" class="chapter done " data-progress="3.9" style="left: 100%;"></a>
    
    </div>
</div>

                <div class="page-inner">
                
                    <section class="normal" id="section-gitbook_3724">
                    
                        <h1 id="-">更新文档中的一部分</h1>
<p>In &lt;<update-doc>&gt;, we said that the way to update a document is to retrieve
it, change it, then reindex the whole document. This is true. However, using
the <code>update</code> API, we can make partial updates like incrementing a counter in a
single request.</p>
<p>We also said that documents are immutable -- they cannot be changed, only
replaced.  The <code>update</code> API <em>must</em> obey the same rules.  Externally, it
appears as though we are partially updating a document in place. Internally,
however, the <code>update</code> API simply manages the same <em>retrieve-change-reindex</em>
process that we have already described. The difference is that this process
happens within a shard, thus avoiding the network overhead of multiple
requests. By reducing the time between the <em>retrieve</em> and <em>reindex</em> steps, we
also reduce the likelihood of there being conflicting changes from other
processes.</p>
<p>The simplest form of the <code>update</code> request accepts a partial document as the
<code>&quot;doc&quot;</code> parameter which just gets merged with the existing document -- objects
are merged together, existing scalar fields are overwritten and new fields are
added. For instance, we could add a <code>tags</code> field and a <code>views</code> field to our
blog post with:</p>
<pre><code class="lang-js">POST /website/blog/<span class="hljs-number">1</span>/_update
{
   <span class="hljs-string">"doc"</span> : {
      <span class="hljs-string">"tags"</span> : [ <span class="hljs-string">"testing"</span> ],
      <span class="hljs-string">"views"</span>: <span class="hljs-number">0</span>
   }
}
···

If the request succeeds, we see a response similar to that
of the `index` request:

```js
{
   <span class="hljs-string">"_index"</span> :   <span class="hljs-string">"website"</span>,
   <span class="hljs-string">"_id"</span> :      <span class="hljs-string">"1"</span>,
   <span class="hljs-string">"_type"</span> :    <span class="hljs-string">"blog"</span>,
   <span class="hljs-string">"_version"</span> : <span class="hljs-number">3</span>
}
</code></pre>
<p>Retrieving the document shows the updated <code>_source</code> field:</p>
<pre><code class="lang-js">{
   <span class="hljs-string">"_index"</span>:    <span class="hljs-string">"website"</span>,
   <span class="hljs-string">"_type"</span>:     <span class="hljs-string">"blog"</span>,
   <span class="hljs-string">"_id"</span>:       <span class="hljs-string">"1"</span>,
   <span class="hljs-string">"_version"</span>:  <span class="hljs-number">3</span>,
   <span class="hljs-string">"found"</span>:     <span class="hljs-literal">true</span>,
   <span class="hljs-string">"_source"</span>: {
      <span class="hljs-string">"title"</span>:  <span class="hljs-string">"My first blog entry"</span>,
      <span class="hljs-string">"text"</span>:   <span class="hljs-string">"Starting to get the hang of this..."</span>,
      <span class="hljs-string">"tags"</span>: [ <span class="hljs-string">"testing"</span> ], <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">1</span>&gt;</span>
      "views":  0 <span class="hljs-tag">&lt;<span class="hljs-title">1</span>&gt;</span>
   }
}</span>
</code></pre>
<ol>
<li>Our new fields have been added to the <code>_source</code>.</li>
</ol>
<h4 id="using-scripts-to-make-partial-updates">Using scripts to make partial updates</h4>
<hr>
<p>We will discuss scripting in more detail in &lt;<scripting>&gt;, but for now it is
enough to know that scripts can be used in several places in Elasticsearch to
achieve custom actions that are not directly supported by the API. The
default scripting language is called MVEL, but Elasticsearch also supports
JavaScript, Groovy and Python.</p>
<p>MVEL is a simple fast Java-based dynamic scripting language with a syntax
similar to Javascript. You can read more about MVEL in the
<a href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-scripting.html[Elasticsearch" target="_blank">http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-scripting.html[Elasticsearch</a> scripting docs]
and on the <a href="http://mvel.codehaus.org/Getting+Started+for+2.0[MVEL" target="_blank">http://mvel.codehaus.org/Getting+Started+for+2.0[MVEL</a> website].</p>
<hr>
<p>Scripts can be used in the <code>update</code> API to change the contents of the <code>_source</code>
field, which is referred to inside an update script as <code>ctx._source</code>. For
instance, we could use a script to increment the number of <code>views</code> that our
blog post has had:</p>
<pre><code class="lang-js">POST /website/blog/<span class="hljs-number">1</span>/_update
{
   <span class="hljs-string">"script"</span> : <span class="hljs-string">"ctx._source.views+=1"</span>
}
</code></pre>
<p>We can also use a script to add a new tag to the <code>tags</code> array.  In this
example we specify the new tag as a parameter rather than hard coding it in
the script itself. This allows Elasticsearch to reuse the script in the
future, without having to compile a new script every time we want to add
another tag:</p>
<pre><code class="lang-js">POST /website/blog/<span class="hljs-number">1</span>/_update
{
   <span class="hljs-string">"script"</span> : <span class="hljs-string">"ctx._source.tags+=new_tag"</span>,
   <span class="hljs-string">"params"</span> : {
      <span class="hljs-string">"new_tag"</span> : <span class="hljs-string">"search"</span>
   }
}
</code></pre>
<p>Fetching the document shows the effect of the last two requests:</p>
<pre><code class="lang-js">{
   <span class="hljs-string">"_index"</span>:    <span class="hljs-string">"website"</span>,
   <span class="hljs-string">"_type"</span>:     <span class="hljs-string">"blog"</span>,
   <span class="hljs-string">"_id"</span>:       <span class="hljs-string">"1"</span>,
   <span class="hljs-string">"_version"</span>:  <span class="hljs-number">5</span>,
   <span class="hljs-string">"found"</span>:     <span class="hljs-literal">true</span>,
   <span class="hljs-string">"_source"</span>: {
      <span class="hljs-string">"title"</span>:  <span class="hljs-string">"My first blog entry"</span>,
      <span class="hljs-string">"text"</span>:   <span class="hljs-string">"Starting to get the hang of this..."</span>,
      <span class="hljs-string">"tags"</span>:  [<span class="hljs-string">"testing"</span>, <span class="hljs-string">"search"</span>], <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">1</span>&gt;</span>
      "views":  1 <span class="hljs-tag">&lt;<span class="hljs-title">2</span>&gt;</span>
   }
}</span>
</code></pre>
<ol>
<li>The <code>search</code> tag has been appended to the <code>tags</code> array.</li>
<li>The <code>views</code> field has been incremented.</li>
</ol>
<p>We can even choose to delete a document based on it contents,
by setting <code>ctx.op</code> to <code>delete</code>:</p>
<pre><code class="lang-js">POST /website/blog/<span class="hljs-number">1</span>/_update
{
   <span class="hljs-string">"script"</span> : <span class="hljs-string">"ctx.op = ctx._source.views == count ? 'delete' : 'none'"</span>,
    <span class="hljs-string">"params"</span> : {
        <span class="hljs-string">"count"</span>: <span class="hljs-number">1</span>
    }
}
</code></pre>
<h3 id="updating-a-document-which-may-not-yet-exist">Updating a document which may not yet exist</h3>
<p>Imagine that we need to store a pageview counter in Elasticsearch. Every time
that a user views a page, we increment the counter for that page.  But if it
is a new page, we can&#39;t be sure that the counter already exists. If we try to
update a non-existent document, the update will fail.</p>
<p>In cases like these, we can use the <code>upsert</code> parameter to specify the
document that should be created if it doesn&#39;t already exist:</p>
<pre><code class="lang-js">POST /website/pageviews/<span class="hljs-number">1</span>/_update
{
   <span class="hljs-string">"script"</span> : <span class="hljs-string">"ctx._source.views+=1"</span>,
   <span class="hljs-string">"upsert"</span>: {
       <span class="hljs-string">"views"</span>: <span class="hljs-number">1</span>
   }
}
</code></pre>
<p>The first time we run this request, the <code>upsert</code> value is indexed as a new
document, which  initializes the <code>views</code> field to <code>1</code>. On subsequent runs the
document already exists so the <code>script</code> update is applied instead,
incrementing the <code>views</code> counter.</p>
<h3 id="updates-and-conflicts">Updates and conflicts</h3>
<p>In the introduction to this section, we said that the smaller the window between
the <em>retrieve</em> and <em>reindex</em> steps, the smaller the opportunity for
conflicting changes. But it doesn&#39;t eliminate the possibility completely. It
is still possible that a request from another process could change the
document before <code>update</code> has managed to reindex it.</p>
<p>To avoid losing data, the <code>update</code> API retrieves the current <code>_version</code>
of the document in the <em>retrieve</em> step, and passes that to the <code>index</code> request
during the <em>reindex</em> step.
If another process has changed the document in between <em>retrieve</em> and <em>reindex</em>,
then the <code>_version</code> number won&#39;t match and the update request will fail.</p>
<p>For many uses of partial update, it doesn&#39;t matter that a document has been
changed.  For instance, if two processes are both incrementing the page
view counter, it doesn&#39;t matter in which order it happens -- if a conflict
occurs, the only thing we need to do is to reattempt the update.</p>
<p>This can be done automatically by setting the <code>retry_on_conflict</code> parameter to
the number of times that <code>update</code> should retry before failing -- it defaults
to <code>0</code>.</p>
<pre><code class="lang-js">POST /website/pageviews/<span class="hljs-number">1</span>/_update?retry_on_conflict=<span class="hljs-number">5</span> &lt;<span class="hljs-number">1</span>&gt;
{
   <span class="hljs-string">"script"</span> : <span class="hljs-string">"ctx._source.views+=1"</span>,
   <span class="hljs-string">"upsert"</span>: {
       <span class="hljs-string">"views"</span>: <span class="hljs-number">0</span>
   }
}
</code></pre>
<ol>
<li>Retry this update 5 times before failing.</li>
</ol>
<p>This works well for operations like incrementing a counter where the order of
increments does not matter, but there are other situations where the order of
changes <em>is</em> important. Like the &lt;<index-doc,`index` API>&gt;, the <code>update</code> API
adopts a <code>`last-write-wins&#39;&#39; approach by default, but it also accepts a</code>version` parameter which allows you to use
&lt;<optimistic-concurrency-control,optimistic concurrency control>&gt; to specify
which version of the document you intend to update.</p>

                    
                    </section>
                
                </div>
            </div>
        </div>

        
        <a href="../data/version_control.html" class="navigation navigation-prev " aria-label="Previous page: 版本控制"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../data/mget.html" class="navigation navigation-next " aria-label="Next page: Mget"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/jsrepl/jsrepl.js" id="jsrepl-script"></script>
<script src="../gitbook/app.js"></script>

    
    <script src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
